WITH NFs AS (
  SELECT 
    nf.bukrs,
    nf.branch,
    nf.parid,
    nf.name1,
    nf.pstdat,
    format_date('%m-%y', nf.pstdat) as Mes_Ano,
    nf.direct,
    nf.nfenum,
    nf.cancel,
    nf.crenam,
    lin.matnr,
    lin.maktx,
    lin.cfop,
    CASE
      WHEN lin.matnr = '100923' THEN '2'
      WHEN lin.matnr = '100935' THEN '2'
      WHEN lin.matnr = '101037' THEN '253'
      WHEN lin.matnr = '101038' THEN '118'
      WHEN lin.matnr = '101039' THEN '108'
      WHEN lin.matnr = '101044' THEN '852'
      WHEN lin.matnr = '101052' THEN '1043'
      WHEN lin.matnr = '101053' THEN '4' 
      WHEN lin.matnr = '101059' THEN '221'
      WHEN lin.matnr = '101062' THEN '0'
      WHEN lin.matnr = '101066' THEN '18'
      WHEN lin.matnr = '101068' THEN '242'
      WHEN lin.matnr = '101072' THEN '52'
      WHEN lin.matnr = '101074' THEN '35'
      WHEN lin.matnr = '101079' THEN '264'
      WHEN lin.matnr = '101082' THEN '26'
      WHEN lin.matnr = '101084' THEN '10'
      WHEN lin.matnr = '101092' THEN '80'
      WHEN lin.matnr = '101098' THEN '91'
      WHEN lin.matnr = '101121' THEN '24'
      WHEN lin.matnr = '101127' THEN '12'
      WHEN lin.matnr = '101132' THEN '72'
      WHEN lin.matnr = '101034' THEN '4'
      WHEN lin.matnr = '101140' THEN '4'
      WHEN lin.matnr = '101151' THEN '0'
      WHEN lin.matnr = '101152' THEN '24'
      WHEN lin.matnr = '101155' THEN '0'
      WHEN lin.matnr = '101172' THEN '30'
      WHEN lin.matnr = '101192' THEN '4'
      WHEN lin.matnr = '101241' THEN '2'
      WHEN lin.matnr = '101524' THEN '0'
      WHEN lin.matnr = '101568' THEN '10'
      WHEN lin.matnr = '101572' THEN '3'
      WHEN lin.matnr = '101575' THEN '4'
      WHEN lin.matnr = '101592' THEN '55'
      WHEN lin.matnr = '101593' THEN '18'
      WHEN lin.matnr = '101605' THEN '9'
      WHEN lin.matnr = '101606' THEN '0'
      WHEN lin.matnr = '101657' THEN '32'
      WHEN lin.matnr = '101658' THEN '10'
      WHEN lin.matnr = '101659' THEN '24'
      WHEN lin.matnr = '101671' THEN '0'
      WHEN lin.matnr = '101685' THEN '0'
      WHEN lin.matnr = '101688' THEN '5'
      WHEN lin.matnr = '101881' THEN '4'
      WHEN lin.matnr = '101885' THEN '4'
      WHEN lin.matnr = '101911' THEN '2'
      WHEN lin.matnr = '101947' THEN '0'
      WHEN lin.matnr = '101975' THEN '8'
      WHEN lin.matnr = '102041' THEN '20'
      WHEN lin.matnr = '102043' THEN '46'
      WHEN lin.matnr = '102773' THEN '0'
      WHEN lin.matnr = '102906' THEN '16'
      WHEN lin.matnr = '102914' THEN '82'
      WHEN lin.matnr = '102915' THEN '36'
      WHEN lin.matnr = '102921' THEN '2'
      WHEN lin.matnr = '102924' THEN '8'
      WHEN lin.matnr = '102948' THEN '2'
      WHEN lin.matnr = '102957' THEN '10'
      WHEN lin.matnr = '102958' THEN '36'
      WHEN lin.matnr = '102981' THEN '90'
      WHEN lin.matnr = '103067' THEN '2'
      WHEN lin.matnr = '103332' THEN '6'
      WHEN lin.matnr = '103440' THEN '2'
      WHEN lin.matnr = '103445' THEN '10'
      WHEN lin.matnr = '103449' THEN '4'
      WHEN lin.matnr = '103454' THEN '4'
      WHEN lin.matnr = '103633' THEN '22'
      WHEN lin.matnr = '103634' THEN '20'
      WHEN lin.matnr = '103641' THEN '220'
      WHEN lin.matnr = '103642' THEN '67'
      WHEN lin.matnr = '103736' THEN '393'
      WHEN lin.matnr = '103738' THEN '176'
      WHEN lin.matnr = '103760' THEN '4'
      WHEN lin.matnr = '103843' THEN '2'
      WHEN lin.matnr = '104218' THEN '29'
      WHEN lin.matnr = '104241' THEN '2'
      WHEN lin.matnr = '104251' THEN '60'
      WHEN lin.matnr = '104252' THEN '1'
      WHEN lin.matnr = '104304' THEN '64'
      WHEN lin.matnr = '104313' THEN '0'
      WHEN lin.matnr = '104320' THEN '3'
      WHEN lin.matnr = '104323' THEN '4'
      WHEN lin.matnr = '104336' THEN '176'
      WHEN lin.matnr = '104337' THEN '11'
      WHEN lin.matnr = '104339' THEN '50'
      WHEN lin.matnr = '104358' THEN '16'
      WHEN lin.matnr = '104409' THEN '12'
      WHEN lin.matnr = '104420' THEN '18'
      WHEN lin.matnr = '104443' THEN '0'
      WHEN lin.matnr = '104444' THEN '174'
      WHEN lin.matnr = '104455' THEN '14'
      WHEN lin.matnr = '104521' THEN '9'
      WHEN lin.matnr = '104646' THEN '4'
      WHEN lin.matnr = '104759' THEN '6'
      WHEN lin.matnr = '104779' THEN '2'
      WHEN lin.matnr = '104780' THEN '194'
      WHEN lin.matnr = '104782' THEN '239'
      WHEN lin.matnr = '104834' THEN '32'
      WHEN lin.matnr = '104914' THEN '6'
      WHEN lin.matnr = '104917' THEN '0'
      WHEN lin.matnr = '105060' THEN '9'
      WHEN lin.matnr = '105172' THEN '2'
      WHEN lin.matnr = '105177' THEN '4'
      WHEN lin.matnr = '105332' THEN '34'
      WHEN lin.matnr = '105336' THEN '92'
      WHEN lin.matnr = '105336' THEN '0'
      WHEN lin.matnr = '105366' THEN '0'
      WHEN lin.matnr = '105477' THEN '54'
      WHEN lin.matnr = '105478' THEN '210'
      WHEN lin.matnr = '105496' THEN '4'
      WHEN lin.matnr = '105520' THEN '0'
      WHEN lin.matnr = '105526' THEN '2'
      WHEN lin.matnr = '105661' THEN '4'
      WHEN lin.matnr = '105662' THEN '4'
      WHEN lin.matnr = '105668' THEN '2'
      WHEN lin.matnr = '105670' THEN '2'
      WHEN lin.matnr = '105714' THEN '72'
      WHEN lin.matnr = '105715' THEN '20'
      WHEN lin.matnr = '105717' THEN '20'
      WHEN lin.matnr = '105718' THEN '11' 
      WHEN lin.matnr = '105726' THEN '122'
      WHEN lin.matnr = '105842' THEN '8'
      WHEN lin.matnr = '105976' THEN '0'
      WHEN lin.matnr = '105981' THEN '0'
      WHEN lin.matnr = '106017' THEN '4'
      WHEN lin.matnr = '106031' THEN '11'
      WHEN lin.matnr = '106202' THEN '10'
      WHEN lin.matnr = '106209' THEN '24'
      WHEN lin.matnr = '106211' THEN '10'
      WHEN lin.matnr = '106220' THEN '12'
      WHEN lin.matnr = '106240' THEN '66'
      WHEN lin.matnr = '106261' THEN '68'
      WHEN lin.matnr = '106300' THEN '0'
      WHEN lin.matnr = '106302' THEN '14'
      WHEN lin.matnr = '106304' THEN '6'
      WHEN lin.matnr = '106329' THEN '30'
      WHEN lin.matnr = '106383' THEN '10'
      WHEN lin.matnr = '106391' THEN '60'
      WHEN lin.matnr = '106416' THEN '2'
      WHEN lin.matnr = '106422' THEN '10'
      ELSE 'Nada'
    END Consumo,
    lin.menge,
    lin.netwr,
    nf.natop,
    lin.refkey,
    lin.docnum
  FROM 
    `production-servers-magnumtires.prdmgm_sap_cdc_processed.j_1bnfdoc` AS nf
  INNER JOIN 
    `production-servers-magnumtires.prdmgm_sap_cdc_processed.j_1bnflin` AS lin
    ON lin.docnum = nf.docnum
  WHERE 
    nf.pstdat > '2023-10-31'  
    AND lin.cfop NOT LIKE '%AB%'
    AND nf.nfenum NOT LIKE ''
    AND nf.parid IN ('1000120770', '1000085876', '1000059152', '1000159084', 
                     '1000163133', '1000163210', '1000163607', '1000144146', 
                     '1000170951')
),
Duplicadas AS (
  SELECT 
    NFENUM
  FROM 
    NFs
  GROUP BY 
    NFENUM
  HAVING 
    COUNT(DISTINCT cancel) > 1
)
SELECT DISTINCT
  CONCAT(LEFT(nfs.bukrs, 2), RIGHT(nfs.branch, 2)) AS Centro,
  nfs.parid AS ID_Externo,
  nfs.name1 AS Cliente,
  nfs.pstdat AS DataNF,
  format_date('%m-%y', nfs.pstdat) as Mes_Ano,
  CASE
    WHEN nfs.direct = '1' THEN 'Entrada'
    WHEN nfs.direct = '2' THEN 'Sa√≠da'
    ELSE 'Nada'
  END AS DirecaoNF,
  nfs.nfenum AS Num_nfe, 
  nfs.cancel AS Cancelamento,
  nfs.crenam AS Usuario,
  RIGHT(nfs.matnr, 6) AS Codigo_Material,
  nfs.maktx AS Texto_Breve_Material,
  nfs.cfop AS CFOP,
    CASE
      WHEN RIGHT(nfs.matnr, 6) = '100923' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '100935' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '101037' THEN '253'
      WHEN RIGHT(nfs.matnr, 6) = '101038' THEN '118'
      WHEN RIGHT(nfs.matnr, 6) = '101039' THEN '108'
      WHEN RIGHT(nfs.matnr, 6) = '101044' THEN '852'
      WHEN RIGHT(nfs.matnr, 6) = '101052' THEN '1043'
      WHEN RIGHT(nfs.matnr, 6) = '101053' THEN '4' 
      WHEN RIGHT(nfs.matnr, 6) = '101059' THEN '221'
      WHEN RIGHT(nfs.matnr, 6) = '101062' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '101066' THEN '18'
      WHEN RIGHT(nfs.matnr, 6) = '101068' THEN '242'
      WHEN RIGHT(nfs.matnr, 6) = '101072' THEN '52'
      WHEN RIGHT(nfs.matnr, 6) = '101074' THEN '35'
      WHEN RIGHT(nfs.matnr, 6) = '101079' THEN '264'
      WHEN RIGHT(nfs.matnr, 6) = '101082' THEN '26'
      WHEN RIGHT(nfs.matnr, 6) = '101084' THEN '10'
      WHEN RIGHT(nfs.matnr, 6) = '101092' THEN '80'
      WHEN RIGHT(nfs.matnr, 6) = '101098' THEN '91'
      WHEN RIGHT(nfs.matnr, 6) = '101121' THEN '24'
      WHEN RIGHT(nfs.matnr, 6) = '101127' THEN '12'
      WHEN RIGHT(nfs.matnr, 6) = '101132' THEN '72'
      WHEN RIGHT(nfs.matnr, 6) = '101034' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '101140' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '101151' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '101152' THEN '24'
      WHEN RIGHT(nfs.matnr, 6) = '101155' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '101172' THEN '30'
      WHEN RIGHT(nfs.matnr, 6) = '101192' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '101241' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '101524' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '101568' THEN '10'
      WHEN RIGHT(nfs.matnr, 6) = '101572' THEN '3'
      WHEN RIGHT(nfs.matnr, 6) = '101575' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '101592' THEN '55'
      WHEN RIGHT(nfs.matnr, 6) = '101593' THEN '18'
      WHEN RIGHT(nfs.matnr, 6) = '101605' THEN '9'
      WHEN RIGHT(nfs.matnr, 6) = '101606' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '101657' THEN '32'
      WHEN RIGHT(nfs.matnr, 6) = '101658' THEN '10'
      WHEN RIGHT(nfs.matnr, 6) = '101659' THEN '24'
      WHEN RIGHT(nfs.matnr, 6) = '101671' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '101685' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '101688' THEN '5'
      WHEN RIGHT(nfs.matnr, 6) = '101881' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '101885' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '101911' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '101947' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '101975' THEN '8'
      WHEN RIGHT(nfs.matnr, 6) = '102041' THEN '20'
      WHEN RIGHT(nfs.matnr, 6) = '102043' THEN '46'
      WHEN RIGHT(nfs.matnr, 6) = '102773' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '102906' THEN '16'
      WHEN RIGHT(nfs.matnr, 6) = '102914' THEN '82'
      WHEN RIGHT(nfs.matnr, 6) = '102915' THEN '36'
      WHEN RIGHT(nfs.matnr, 6) = '102921' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '102924' THEN '8'
      WHEN RIGHT(nfs.matnr, 6) = '102948' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '102957' THEN '10'
      WHEN RIGHT(nfs.matnr, 6) = '102958' THEN '36'
      WHEN RIGHT(nfs.matnr, 6) = '102981' THEN '90'
      WHEN RIGHT(nfs.matnr, 6) = '103067' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '103332' THEN '6'
      WHEN RIGHT(nfs.matnr, 6) = '103440' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '103445' THEN '10'
      WHEN RIGHT(nfs.matnr, 6) = '103449' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '103454' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '103633' THEN '22'
      WHEN RIGHT(nfs.matnr, 6) = '103634' THEN '20'
      WHEN RIGHT(nfs.matnr, 6) = '103641' THEN '220'
      WHEN RIGHT(nfs.matnr, 6) = '103642' THEN '67'
      WHEN RIGHT(nfs.matnr, 6) = '103736' THEN '393'
      WHEN RIGHT(nfs.matnr, 6) = '103738' THEN '176'
      WHEN RIGHT(nfs.matnr, 6) = '103760' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '103843' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '104218' THEN '29'
      WHEN RIGHT(nfs.matnr, 6) = '104241' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '104251' THEN '60'
      WHEN RIGHT(nfs.matnr, 6) = '104252' THEN '1'
      WHEN RIGHT(nfs.matnr, 6) = '104304' THEN '64'
      WHEN RIGHT(nfs.matnr, 6) = '104313' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '104320' THEN '3'
      WHEN RIGHT(nfs.matnr, 6) = '104323' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '104336' THEN '176'
      WHEN RIGHT(nfs.matnr, 6) = '104337' THEN '11'
      WHEN RIGHT(nfs.matnr, 6) = '104339' THEN '50'
      WHEN RIGHT(nfs.matnr, 6) = '104358' THEN '16'
      WHEN RIGHT(nfs.matnr, 6) = '104409' THEN '12'
      WHEN RIGHT(nfs.matnr, 6) = '104420' THEN '18'
      WHEN RIGHT(nfs.matnr, 6) = '104443' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '104444' THEN '174'
      WHEN RIGHT(nfs.matnr, 6) = '104455' THEN '14'
      WHEN RIGHT(nfs.matnr, 6) = '104521' THEN '9'
      WHEN RIGHT(nfs.matnr, 6) = '104646' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '104759' THEN '6'
      WHEN RIGHT(nfs.matnr, 6) = '104779' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '104780' THEN '194'
      WHEN RIGHT(nfs.matnr, 6) = '104782' THEN '239'
      WHEN RIGHT(nfs.matnr, 6) = '104834' THEN '32'
      WHEN RIGHT(nfs.matnr, 6) = '104914' THEN '6'
      WHEN RIGHT(nfs.matnr, 6) = '104917' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '105060' THEN '9'
      WHEN RIGHT(nfs.matnr, 6) = '105172' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '105177' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '105332' THEN '34'
      WHEN RIGHT(nfs.matnr, 6) = '105336' THEN '92'
      WHEN RIGHT(nfs.matnr, 6) = '105336' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '105366' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '105477' THEN '54'
      WHEN RIGHT(nfs.matnr, 6) = '105478' THEN '210'
      WHEN RIGHT(nfs.matnr, 6) = '105496' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '105520' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '105526' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '105661' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '105662' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '105668' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '105670' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '105714' THEN '72'
      WHEN RIGHT(nfs.matnr, 6) = '105715' THEN '20'
      WHEN RIGHT(nfs.matnr, 6) = '105717' THEN '20'
      WHEN RIGHT(nfs.matnr, 6) = '105718' THEN '11' 
      WHEN RIGHT(nfs.matnr, 6) = '105726' THEN '122'
      WHEN RIGHT(nfs.matnr, 6) = '105842' THEN '8'
      WHEN RIGHT(nfs.matnr, 6) = '105976' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '105981' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '106017' THEN '4'
      WHEN RIGHT(nfs.matnr, 6) = '106031' THEN '11'
      WHEN RIGHT(nfs.matnr, 6) = '106202' THEN '10'
      WHEN RIGHT(nfs.matnr, 6) = '106209' THEN '24'
      WHEN RIGHT(nfs.matnr, 6) = '106211' THEN '10'
      WHEN RIGHT(nfs.matnr, 6) = '106220' THEN '12'
      WHEN RIGHT(nfs.matnr, 6) = '106240' THEN '66'
      WHEN RIGHT(nfs.matnr, 6) = '106261' THEN '68'
      WHEN RIGHT(nfs.matnr, 6) = '106300' THEN '0'
      WHEN RIGHT(nfs.matnr, 6) = '106302' THEN '14'
      WHEN RIGHT(nfs.matnr, 6) = '106304' THEN '6'
      WHEN RIGHT(nfs.matnr, 6) = '106329' THEN '30'
      WHEN RIGHT(nfs.matnr, 6) = '106383' THEN '10'
      WHEN RIGHT(nfs.matnr, 6) = '106391' THEN '60'
      WHEN RIGHT(nfs.matnr, 6) = '106416' THEN '2'
      WHEN RIGHT(nfs.matnr, 6) = '106422' THEN '10'
      ELSE 'Nada'
    END Consumo,
  nfs.menge AS Quantidade,
  nfs.netwr AS Montante,
  nfs.natop AS Referencia,
  nfs.refkey AS Doc_Orig,
  nfs.docnum AS Doc_Num_Lin
FROM 
  NFs AS nfs
LEFT JOIN 
  Duplicadas AS dup
  ON nfs.nfenum = dup.nfenum
WHERE 
  dup.nfenum IS NULL